@{
    ViewData["Title"] = "ProjectFileList";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@{
    Html.RenderPartial("_ProjectDetailPartialView");
}

<div class="d-flex flex-wrap flex-stack my-5">
    <!--begin::Heading-->
    <h3 class="fw-bolder my-2">
        Proje Dosyaları
    </h3>

</div>
<div class="alert alert-danger d-flex align-items-center p-5 mb-10">
    <span class="svg-icon svg-icon-2hx svg-icon-danger me-4">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
            <rect opacity="0.3" x="2" y="2" width="20" height="20" rx="10" fill="currentColor" />
            <rect x="11" y="14" width="7" height="2" rx="1" transform="rotate(-90 11 14)" fill="currentColor" />
            <rect x="11" y="17" width="2" height="2" rx="1" transform="rotate(-90 11 17)" fill="currentColor" />
        </svg>
    </span>
    <div class="d-flex flex-column">
        <h4 class="mb-1 text-danger">Uyarı</h4>
        <span>Bu sistemle uyumlu son kontrol edilmiş SSI uyumu <b class="text-danger">9.3.1</b> dir.</span>
    </div>
</div>
<div class="row g-6 g-xl-9 mb-6 mb-xl-9">
    @if (!String.IsNullOrEmpty(ViewBag.ProjectName))
    {
        <div class="col-md-6 col-lg-4 col-xl-3">
            <div class="card h-100">
                <div class="card-body d-flex justify-content-center text-center flex-column p-8 " id="file-target">

                    <a href="#" id="download-button" class="text-gray-800 text-hover-primary d-flex flex-column">
                        <div class="symbol symbol-60px mb-5">
                            <img src="assets/media/svg/files/doc.svg" alt="">
                        </div>
                        <div class="fs-5 fw-bolder mb-2">@($"{ViewBag.ProjectName}.xlsx")</div>
                    </a>
                    <div class="fs-7 fw-bold text-gray-400">@ViewBag.CreatedDateDifference gün önce</div>
                    <div class="fs-7 fw-bold mt-3">
                        <a href="#" id="delete-button" class="btn btn-active-danger btn-sm">Sil</a>

                    </div>

                </div>
            </div>
        </div>

    }

    <div class="col-md-6 col-lg-4 col-xl-3">
        <div class="card h-100 flex-center bg-light-primary border-primary border border-dashed p-8">
            <form class="form" action="#" method="post">
                <div class="fv-row">
                    <div class="dropzone" id="kt_dropzonejs_example_1">
                        <div class="dz-message needsclick">
                            <i class="bi bi-file-earmark-arrow-up text-primary fs-3x"></i>
                            <div class="ms-4">
                                <h3 class="fs-5 fw-bolder text-gray-900 mb-1">PrintStudy dosyanızı yükleyiniz.</h3>
                                <span class="fs-7 fw-bold text-gray-400">Sadece 1 dosya seçiniz</span>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    @*  <div class="col-md-6 col-lg-4 col-xl-3">
        <div class="card h-100 flex-center bg-light-info border-info border border-dashed p-8">
            <form class="form" action="#" method="post">
                <div class="fv-row">
                    <div class="dropzone " style="background-color:#F8F5FF;border:1px dashed #7239EA" id="kt_dropzonejs_example_2">
                        <div class="dz-message needsclick">
                            <i class="bi bi-file-earmark-arrow-up text-info fs-3x"></i>
                            <div class="ms-4">
                                <h3 class="fs-5 fw-bolder text-gray-900 mb-1">Proje dosyanızı yükleyiniz.</h3>
                                <span class="fs-7 fw-bold text-gray-400">Sadece 1 dosya seçiniz</span>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div> *@
</div>

@section js {
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');
        var myDropzone = new Dropzone("#kt_dropzonejs_example_1", {
            url: "upload-project-file",
            paramName: "printStudyFile",
            maxFiles: 1,
            maxFilesize: 3,
            params: {
                projectId: projectId
            },
            addRemoveLinks: true,
            accept: function (file, done) {
                if (file.type !== "text/plain") {
                    done("Yalnızca .txt dosyalarına izin verilir.");
                } else {
                    done();
                }
            }
        });
        myDropzone.on("error", function (file, errorMessage, xhr) {
            let errors;
            if (xhr && xhr.responseText) {
                try {
                    let response = JSON.parse(xhr.responseText);
                    errors = response.Errors.join(", ");
                } catch (e) {
                    errors = "Bilinmeyen bir hata oluştu.";
                }
            } else {
                errors = errorMessage;
            }
            Swal.fire({
                text: `Hata: ${errors}`,
                icon: "error",
                buttonsStyling: false,
                confirmButtonText: "Tamam",
                customClass: { confirmButton: "btn fw-bold btn-primary" }
            });
        });
        myDropzone.on("success", function (file, response) {
            Swal.fire({
                text: "Dosya başarıyla yüklendi!",
                icon: "success",
                buttonsStyling: false,
                confirmButtonText: "Tamam",
                customClass: { confirmButton: "btn fw-bold btn-primary" },
            }).then(() => {
                location.reload(true)
                myDropzone.removeAllFiles(true); // Dropzone içeriğini temizle
            });
        });

    </script>
    <script>

        var button = document.querySelector("#download-button");
        var target = document.querySelector("#file-target");

        var blockUI = new KTBlockUI(target, {
            message: '<div class="blockui-message"><span class="spinner-border text-primary"></span> Yükleniyor...</div>',
        });

        button.addEventListener("click", function() {
            if (blockUI.isBlocked()) {
                blockUI.release();
            } else {
                blockUI.block();
                        downloadExcelFile("@ViewBag.ProjectName");
            }
                });

        async function downloadExcelFile(projectName) {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            try {
                const response = await fetch(`download-project-file?projectId=${projectId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    throw new Error('Excel dosyası indirilemedi');
                }
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${projectName}.xlsx`;
                document.body.append(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                blockUI.release(); // Blokajı sonlandır
            } catch (error) {
                console.error('Excel dosyası indirilemedi:', error);
                blockUI.release(); // Blokajı sonlandır
            }
                }

    </script>
    <script>
         var button = document.querySelector("#delete-button");
         var target = document.querySelector("#file-target");

        var block = new KTBlockUI(target, {
            message: '<div class="blockui-message"><span class="spinner-border text-primary"></span> Yükleniyor...</div>',
        });

        button.addEventListener("click", function() {
            if (block.isBlocked()) {
                block.release();
            } else {
                block.block();
                deleteExcelFile("@ViewBag.ProjectName");
            }
        });

        async function deleteExcelFile(projectName) {
           
                }
        
    </script>
}